<analysis>
The trajectory details the AI engineer's work on the CRM Fusion application, primarily focusing on enhancing the nutrition planning feature and introducing a monthly follow-up system. Initially, the engineer resolved a critical frontend bug where the nutrition plan accordion in  collapsed immediately; this was fixed by replacing the accordion with a fullscreen modal and refining state management using . The engineer then tackled various user requests: fine-tuning LLM prompts for nutrition plans (including client greetings and accurate macro calculations), enabling plan regeneration, fixing PDF generation issues (missing  dependency, preserving line breaks, adjusting spacing), and correcting Invalid Date display in the User Dashboard.

The latest major feature introduced is a comprehensive monthly follow-up system. The AI engineer defined backend models and endpoints for follow-up questionnaires and integrated a frontend component for user submissions. A key architectural decision was a hybrid Manual + Auto Backup system for follow-up reminders, centralizing notifications in an Pending Reviews panel in the Admin Dashboard, replacing Clients at Risk. The engineer is currently implementing the backend for this new system.
</analysis>

<product_requirements>
The CRM Fusion application is a full-stack platform managing user/admin authentication, CRM, calendar, profile, and documents. Key features include a diagnostic questionnaire and GPT-driven reports. A central Nutrition Plan for team clients involves a questionnaire, LLM-based plan generation (GPT-4o-mini), admin review/editing, PDF generation, and user download, with plans stored historically and displayed in an accordion UI (later replaced by a modal). Robust email verification was added to prevent ghost registrations. Questionnaire responses are saved immediately for admin-triggered AI or manual plan creation, and client data is hard-deleted. Recent additions include a monthly follow-up questionnaire system, where an AI agent will analyze responses against initial data to generate new nutrition plans, with admin manual control over sending and editable analysis.
</product_requirements>

<key_technical_concepts>
-   **Full-stack Development**: React (Frontend), FastAPI (Backend), MongoDB (Database).
-   **Authentication**: JWT, React Context (), email verification.
-   **LLM Integration**:  (LiteLLM with OpenAI GPT-4o-mini).
-   **UI/UX**: Shadcn UI, modal components, form management.
-   **Data Handling**: Pydantic models, UUIDs, MongoDB.
-   **PDF Generation**: WeasyPrint (backend).
</key_technical_concepts>

<code_architecture>

-   ****: Core FastAPI application.
    -   **Importance**: Handles all API routing, business logic, and database interactions.
    -   **Changes**: Replaced accordion with modal logic. Updated nutrition plan generation endpoint to accept  parameter. Modified PDF generation to include , used  with  extension for line breaks, and adjusted styling. Converted  objects to ISO strings for JSON serialization in user dashboard data. Added new endpoints for follow-up submissions (), retrieving follow-ups (), and AI analysis (). Also added endpoints for  and , and updated  to deactivate the follow-up button on submission.
-   ****: Pydantic data models.
    -   **Importance**: Defines the structure and validation for data exchanged with the frontend and stored in MongoDB.
    -   **Changes**: Added  model to store monthly follow-up questionnaire responses. Added a  field to the  model to manage the state of the follow-up button.
-   ****: Manages LLM interaction.
    -   **Importance**: Contains the logic and prompts for generating nutrition plans using GPT-4o-mini.
    -   **Changes**: Multiple iterations to refine LLM prompts: initially removed client intro/technical calculations, then restored calculations for accuracy (while managing presentation), and finally reverted to full technical details plus a personalized greeting based on user feedback. The prompt for AGENT 2 was adjusted to ensure precise macro calculations.
-   ****: Admin interface.
    -   **Importance**: Central hub for admin to manage clients, view plans, and now manage follow-ups.
    -   **Changes**: Replaced nutrition plan accordion with a fullscreen modal ( component). Implemented , , ,  states/functions. Updated action buttons (e.g., Generar PDF to Adjuntar a Documentos, added Regenerar Plan). Corrected , , ,  functions to use . Added a card to the Formularios tab for sending the monthly follow-up questionnaire link. Added a new Seguimientos tab () to display client follow-up data. States (, ) and a  function were added. Call  when  changes.
-   ****: User interface.
    -   **Importance**: Where users view their plans and submit questionnaires.
    -   **Changes**: Modified the success message after submitting the nutrition questionnaire. Added logic to calculate  from . Implemented a new card and button for Cuestionario de Seguimiento visible when . Integrated the new  component.
-   ****: UI component for modals.
    -   **Importance**: Provides a reusable dialog/modal component based on Shadcn UI.
    -   **Changes**: No direct changes, but heavily utilized in  for the new modal.
-   ****: New component.
    -   **Importance**: Frontend form for clients to submit their monthly follow-up questionnaire responses.
    -   **Changes**: New file created to handle the follow-up questionnaire.
</code_architecture>

<pending_tasks>
-   Address Error al conectar con Google Calendar (implement fallback Open Google Calendar button).
-   Address mobile responsiveness issues for user dashboard documents.
-   Complete backend logic for  to fetch clients for review.
-   Complete backend logic for .
-   Implement frontend Revisiones Pendientes card in , replacing Clientes en Riesgo.
-   Implement AI agent for analyzing follow-up responses and generating new nutrition plans (prompt needed).
-   Design and implement admin notification system for follow-ups (alerts, emails, WhatsApp).
-   Ensure AI analysis generated for follow-ups is editable by the admin.
-   Implement the Desaparece de pendientes después de X días logic for the Revisiones Pendientes card.
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer was implementing a comprehensive monthly follow-up system for clients. The previous accordion bug in  was resolved by replacing it with a fullscreen modal. The engineer has since focused on the new follow-up feature, starting with the backend.

The current work involves:
1.  **Adding new backend endpoints** to  for managing follow-up submissions (), retrieving follow-ups (), and AI analysis ().
2.  **Defining a new data model**  in  to store these responses.
3.  **Implementing a hybrid Manual + Auto Backup system** for follow-up reminders. This involves introducing a  field to the  model.
4.  **Creating a new frontend component**  for the user to submit the questionnaire.
5.  **Integrating the follow-up questionnaire visibility** in , displaying a button when  is >= 30 days.
6.  **Adding an admin control** in  under the Formularios tab, allowing admins to manually trigger the follow-up questionnaire link.
7.  **Setting up a Seguimientos tab** in  to display client follow-up history.
8.  **Implementing the core backend logic** for the proposed Revisiones Pendientes feature. The AI engineer has just inserted new endpoints (expected to be  and ) into .
9.  **Modifying the  endpoint** in  to automatically deactivate the  status (which controls the client's visible follow-up button) once a client submits a questionnaire.
10. **Updating the  endpoint** in  to include the  status, allowing the frontend to correctly display or hide the follow-up button for the user.
</current_work>

<optional_next_step>
Complete the backend implementation by implementing the logic for  and  endpoints.
</optional_next_step>
