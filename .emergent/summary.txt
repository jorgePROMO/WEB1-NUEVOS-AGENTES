<analysis>
The trajectory details a collaborative refinement of the application's architecture. The initial task was a major refactor to introduce a shared  object for the AI agents, addressing a core flaw of them operating in isolation. The user then introduced a new, critical requirement: integrating two Knowledge Bases (KBs), one for training and one for nutrition, provided as  files.

The AI engineer's first proposal was to embed these KBs within the . The user immediately and firmly rejected this, explaining it was conceptually wrong. The user clarified that KBs are global, static, read-only reference guides, whereas  is the dynamic, client-specific state. The KBs should not be duplicated for each client or persisted in the database.

Following this crucial correction, the AI engineer formulated a new, approved plan. This plan involves storing the KBs as versioned text files on the filesystem, loading them once in the , and passing the relevant KB to each agent as a separate context from the . The agent prompts will be engineered to prioritize the client's data over the KB's general guidance. The work concluded with the AI engineer having a clear, user-approved implementation plan and awaiting the go-ahead.

The user's primary language is Spanish. The next agent **MUST** respond in Spanish.
</analysis>

<product_requirements>
The E.D.N.360 application is an AI-powered platform for generating personalized, progressive training and nutrition plans.

**Core Functional Requirements:**
1.  **AI-Powered Plan Generation:** The system uses a chain of specialized AI agents (E-agents for training, N-agents for nutrition) to create comprehensive plans.
2.  **Shared Agent Context:** All agents must operate on a single, shared  object. This object contains all client-specific data, questionnaires, previous plans, and the outputs of preceding agents, ensuring data consistency throughout the generation process.
3.  **Global Knowledge Base Integration:** The system must utilize two global, read-only knowledge bases (one for training, one for nutrition) stored as versioned  files. These KBs serve as a reference manual for the agents.
4.  **Data Prioritization:** There is a strict hierarchy of information. The agent's decision-making must always prioritize the specific client data in  over the general guidelines in the knowledge base. The system must adapt theory to the client's reality, not the other way around. The KBs must not be persisted in the database with client data.
</product_requirements>

<key_technical_concepts>
- **Agent-Based AI System:** An orchestrated chain of specialized LLM agents for plan generation.
- **Shared Context Architecture:** A mandatory refactor to use a single, unified  object passed between agents.
- **Global Knowledge Base (KB) Integration:** A new requirement to load static, versioned  files (, ) once and pass them to agents as a separate, read-only reference context, distinct from the .
- **Prompt Engineering:** Critical for instructing agents on the strict data hierarchy:  has absolute priority over the KB.
</key_technical_concepts>

<code_architecture>
The application uses a monorepo structure with a React frontend and a Python/FastAPI backend. The core logic resides in a chain of AI agents orchestrated by the backend.



- ** (New Directory)**:
  - **Importance**: This new directory will house the global, static knowledge bases for training and nutrition, as per the user's explicit instructions. This keeps reference data separate from application code.
  - **Planned Files**: , .

- ****:
  - **Importance**: This file manages the overall flow of the agent chain.
  - **Planned Changes**: It will be modified to load the content of the KB text files into memory once at the start of a generation process. It will then be responsible for passing the appropriate KB content (training or nutrition) to each agent call, alongside the .

- ****:
  - **Importance**: This is the parent class for all AI agents, containing the core LLM interaction logic.
  - **Planned Changes**: The  method will be refactored to accept two distinct arguments: the  (client-specific data) and the  (global reference text). The system prompt construction logic within this file will be updated to include clear instructions on the data hierarchy, ensuring agents prioritize  over the .

</code_architecture>

<pending_tasks>
- **Primary Task**: Implement the architectural refactor for Knowledge Base integration.
  - **Sub-Task 1**: Create the  directory and save the two provided  files with versioning.
  - **Sub-Task 2**: Modify  to load these files into memory at the start of the process.
  - **Sub-Task 3**: Modify  and agent prompts to accept and use the KB as a separate, lower-priority context.
- **On Hold**: Fully implement the  refactor pending the user providing the detailed input/output JSON specifications for each agent (E1-E9, N0-N8).
</pending_tasks>

<current_work>
The immediate work is focused on implementing the user-approved architecture for integrating global knowledge bases (KBs). The previous discussion clarified a critical architectural point: the KBs are **global, static, read-only references** and must be handled separately from the **dynamic, client-specific **.

The agreed-upon plan is:
1.  **Storage**: Create a new directory  and store the user-provided  and  as versioned files (e.g., ).
2.  **Loading**: The  will load these files from the disk into memory **once** when a plan generation is initiated.
3.  **Passing Context**: For each agent call, the orchestrator will pass two separate pieces of context:
    *   The  object (containing only client-specific data).
    *   The relevant KB string ( for E-agents,  for N-agents).
4.  **Prompting**: Prompts will be explicitly engineered to instruct the LLM that the  has absolute priority and the KB is merely a reference guide.

The work is at the very beginning of this implementation phase. The plan is confirmed, and the next step is to start writing the code to create the directory and modify the orchestrator.
</current_work>

<optional_next_step>
Proceed with Step 1 of the implementation plan: Create the  directory and save the versioned KB files.
</optional_next_step>
