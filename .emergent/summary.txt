<analysis>
The trajectory details the debugging and architectural refactoring of a long-running AI plan generation process within the E.D.N.360 application. The initial problem was a  caused by synchronous execution of a multi-agent LLM pipeline (E1-E9 and N0-N8) within a single FastAPI request.

The user explicitly requested a migration to an asynchronous job-based architecture. The initial implementation using FastAPI's  proved insufficient, leading to a cascade of issues including server deadlocks,  event loop conflicts, and recurring login failures. These problems highlighted that  are not suitable for very long-running, CPU/IO-bound processes as they still run within the main server process.

The final and correct architecture, implemented after several failed attempts, completely decouples the job execution from the web server. A new, separate Python worker process (), managed by , is now responsible for polling the  collection in MongoDB and executing the pipelines. The FastAPI server's role is reduced to simply creating the job record and immediately returning a .

Throughout this process, numerous bugs were fixed, including incorrect frontend environment variables, missing  prefixes in endpoint calls, and Pydantic validation errors. The very last action was an attempt to resolve an OpenAI  error by using an , which then resulted in a  error, indicating that a specific integration library is required.

The user's primary language is Spanish. **The next agent MUST respond in Spanish.**
</analysis>

<product_requirements>
The primary goal is to eliminate  errors during the generation of AI-powered training and nutrition plans. This is achieved by converting the synchronous, long-running API endpoint into a robust, asynchronous job-based system.

**Implementation Details:**
1.  **Asynchronous Execution:** Instead of executing the agent pipelines (E1-E9, N0-N8) within a request, a new endpoint () creates a job record in a MongoDB  collection and returns a  immediately.
2.  **Background Worker:** A separate, persistent worker process is responsible for picking up pending or queued jobs from the database and executing them.
3.  **Status Polling:** A  endpoint allows the frontend to poll for the job's status (, , , ), progress, and results.
4.  **Frontend UX:** The frontend displays a progress modal while polling, providing real-time feedback to the user and showing the final result or error message upon completion.
5.  **System Stability (User-Mandated):** The system must be stable and predictable, incorporating:
    *   A security timeout for stuck jobs.
    *   Real-time progress updates per agent.
    *   Automatic retries for transient API errors.
    *   A concurrency limit to prevent resource exhaustion.
    *   Basic logging for each job's lifecycle.
</product_requirements>

<key_technical_concepts>
- **Asynchronous Job Queue:** Using MongoDB as a message broker to queue and track long-running tasks.
- **Decoupled Worker Process:** Running the intensive AI agent pipeline in a separate Python process managed by  to avoid blocking the main FastAPI web server.
- **FastAPI:** Used for the web API layer, responsible for creating jobs and providing status updates.
- **Pydantic:** For data modeling and validation of API requests and database documents.
- **Frontend Polling:** A client-side pattern where the browser periodically requests updates from the server to track a background task's progress.
</key_technical_concepts>

<code_architecture>
The architecture was refactored from a monolithic API endpoint to a decoupled system with a web server and a separate background worker.

**Directory Structure:**


- ****
    - **Importance:** Serves as the main API layer. It's the entry point for all client requests.
    - **Changes:** The long-running plan generation logic was removed. The endpoint  was added to create a job document in MongoDB and respond immediately. The  endpoint was added for status polling. The use of  was implemented and later removed due to causing server deadlocks. All watchdog/background processing logic was removed from the FastAPI startup event.

- ** (New File)**
    - **Importance:** This is the core of the new asynchronous architecture. It runs as a separate, persistent process.
    - **Summary:** The script runs an infinite loop. In each iteration, it connects to MongoDB, queries for jobs with pending or queued status, and processes them one by one using the existing  function (which was moved here from ). It handles the entire lifecycle of a job, including status updates, retries, and logging.

- ** (New File)**
    - **Importance:** This configuration file ensures the  script is managed by , keeping it running persistently and restarting it on failure.
    - **Summary:** Defines the command to run the worker using the correct Python virtual environment (), sets the working directory, and configures logging.

- ****
    - **Importance:** Defines the Pydantic data models for the application.
    - **Changes:** New models were added to represent the job system: , , , and  to structure the data stored in the  collection.

- ****
    - **Importance:** Defines the core  Pydantic model.
    - **Changes:** The model's configuration was changed from  to . This was a critical fix to resolve a  that occurred because the AI orchestrator was adding fields to the context object that were not explicitly defined in the model.

- ** (New File)**
    - **Importance:** Provides real-time feedback to the user during plan generation.
    - **Summary:** This React component is displayed after a generation job is started. It uses a  hook and  to poll the  endpoint every 3 seconds, updating a progress bar and status message. It handles the completed and failed terminal states.

- ****
    - **Importance:** The main administrative interface where plan generation is initiated.
    - **Changes:** The functions  and  were modified to call the new async endpoint (), receive the , and then open the  to start the polling process.
</code_architecture>

<pending_tasks>
- **API Key Resolution:** The current  is causing a  error. This must be resolved before any further testing can occur. The user needs to provide a valid, funded OpenAI API key.
- **Full Validation & Stress Testing:** As requested by the user, a comprehensive validation is pending:
    1.  Run 3 consecutive  (Training + Nutrition) jobs.
    2.  Run 2 concurrent jobs to test the concurrency limit.
    3.  Simulate a failure to verify error handling.
    4.  Report on execution times, token usage, and system resource load.
</pending_tasks>

<current_work>
The project has successfully completed a major architectural refactor, moving from a blocking, synchronous API to a non-blocking, asynchronous system using a separate background worker process. This correctly solves the root cause of the original  errors and subsequent server deadlocks.

The most recent work involved debugging the new architecture and resolving an OpenAI  error. The attempt to fix this by using the provided  failed, resulting in a new  error. Analysis revealed this key requires a special library (), and a full migration would be a significant, high-risk change.

Therefore, the current state is:
- **Architecture:** Stable and correctly implemented (FastAPI + separate  worker).
- **Functionality:** The job creation, polling, and frontend progress display are all working.
- **Blocker:** The system is **not operational** because it cannot connect to the OpenAI API due to the API key issue (). No generation jobs can be successfully completed until this is resolved. The system is awaiting a valid, standard OpenAI API key to proceed with the user's requested final validation tests.
</current_work>

<optional_next_step>
Ask the user to provide a standard, working OpenAI API key to resolve the  error and unblock the final validation tests.
</optional_next_step>
